# åœ¨OKEä¸­å®‰è£…Buildkit

BuildKitæ˜¯ä¸€ä¸ªå·¥å…·åŒ…ï¼Œç”¨äºä»¥é«˜æ•ˆã€å¯è¡¨è¾¾å’Œå¯é‡å¤çš„æ–¹å¼è½¬æ¢æºä»£ç ä»¥æ„å»ºå·¥ä»¶ã€‚

Buildkitæ˜¯ä¸€ä¸ªç¼–è¯‘å·¥å…·ï¼Œå…·æœ‰docker build/push ç­‰åŠŸèƒ½ï¼Œä¹Ÿèƒ½ç¼“å­˜ä¸­é—´æ­¥éª¤ã€‚

**ä½†æ³¨æ„ï¼Œç¼–è¯‘çš„ä¸­é—´ç¼“å­˜äº§å“æ— æ³•ä¸Šä¼ åˆ°OCIRä¸­ã€‚**ä¹Ÿå°±æ˜¯è¯´ ä¸‹é¢2ä¸ªå‚æ•°çš„typeåŠç›®æ ‡ä¸èƒ½æ˜¯

`registry` å’ŒOCIRçš„åœ°å€ï¼š`--import-cache type=local`  `--export-cache type=local`

![Untitled](Untitled%207.png)

---

## å®‰è£… Buildkit

åº”ç”¨ [https://github.com/moby/buildkit/blob/master/examples/kubernetes/pod.privileged.yaml](https://github.com/moby/buildkit/blob/master/examples/kubernetes/pod.privileged.yaml)ï¼Œ å¦‚æœä¸Šä¸äº†githubå°±ç”¨ä¸‹é¢çš„æ–‡ä»¶

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: buildkitd
spec:
  containers:
 Â   - name: buildkitd
 Â  Â   image: moby/buildkit:master
 Â  Â   readinessProbe:
 Â  Â  Â   exec:
 Â  Â  Â  Â   command:
 Â  Â  Â  Â  Â   - buildctl
 Â  Â  Â  Â  Â   - debug
 Â  Â  Â  Â  Â   - workers
 Â  Â  Â   initialDelaySeconds: 5
 Â  Â  Â   periodSeconds: 30
 Â  Â   livenessProbe:
 Â  Â  Â   exec:
 Â  Â  Â  Â   command:
 Â  Â  Â  Â  Â   - buildctl
 Â  Â  Â  Â  Â   - debug
 Â  Â  Â  Â  Â   - workers
 Â  Â  Â   initialDelaySeconds: 5
 Â  Â  Â   periodSeconds: 30
 Â  Â   securityContext:
 Â  Â  Â   privileged: true
```

```bash
kubectl apply -f pod.privileged.yaml
```

## é…ç½®è®¤è¯

åœ¨è·³æ¿æœºæˆ–æœ¬åœ°ç¼–å†™dockerçš„ç™»å½•è®¤è¯æ–‡ä»¶ã€‚

```bash
nano ~/.docker/config.json
```

```json
{
 Â "auths": {
 Â  Â "<ç§æœ‰ä»“åº“åœ°å€>": {
 Â  Â  Â "auth": "<è®¤è¯ä¿¡æ¯ï¼Œå°±æ˜¯æŠŠ ç”¨æˆ·å:å¯†ç  ç”¨base64ç¼–ç åçš„å­—ç¬¦ä¸²>"
 Â   }
  }
}
```

æ¯”å¦‚ï¼š

```json
{
 Â  Â  Â  Â "auths": {
 Â  Â  Â  Â  Â  Â  Â  Â "iad.ocir.io": {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â "auth": "xxxxxxxxxx"
 Â  Â  Â  Â  Â  Â  Â   }
 Â  Â  Â   }
}
```

<aside>
ğŸ’¡ åªéœ€è¦æ–‡ä»¶ï¼Œä¸éœ€è¦å®‰è£…dockerç­‰è½¯ä»¶ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥å®‰è£…**dockerç¤¾åŒºç‰ˆ**ï¼Œç„¶åç”¨ docker login  æ¥äº§ç”Ÿè¿™ä¸ªè®¤è¯æ–‡ä»¶

</aside>

```bash
sudo yum-config-manager --add-repo  https://download.docker.com/linux/centos/docker-ce.repo
docker login -u <ç§Ÿæˆ·>/<ç”¨æˆ·> <åŒºåŸŸ>.ocir.io 
```

## æµ‹è¯•

ä»https://github.com/moby/buildkit/releases/ ä¸Šä¸‹è½½å·¥å…·åŒ…ï¼Œè§£å‹åå¾—åˆ°builctlå·¥å…·ï¼Œå¹¶æŠŠbuildctlæ·»åŠ åˆ°$PATHä¸­

```bash
wget https://github.com/moby/buildkit/releases/download/v0.13.0/buildkit-v0.13.0.linux-amd64.tar.gz
tar xzvf buildkit-v0.13.0.linux-amd64.tar.gz
```

æµ‹è¯•æ‰“åŒ…å¹¶æ¨é€

```bash
buildctl --addr kube-pod://buildkitd info

./buildctl \
 Â --addr kube-pod://buildkitd \
  build --frontend dockerfile.v0 --local context=./ --local dockerfile=./ \
 Â --output type=image,name=iad.ocir.io/sehubjapacprod/wilbur/abc:test.06,push=true
```

## å‚è€ƒèµ„æ–™

- docker login å‡­è¯ ï¼š [https://blog.csdn.net/Rambo_Yang/article/details/108294632](https://blog.csdn.net/Rambo_Yang/article/details/108294632)
- buildkit: [https://github.com/moby/buildkit/tree/master](https://github.com/moby/buildkit/tree/master)
- å®˜æ–¹å…³äºdocker layerçš„è¯´æ˜
    - [https://docs.docker.com/build/guide/layers/](https://docs.docker.com/build/guide/layers/)
    - [https://docs.docker.com/storage/storagedriver/](https://docs.docker.com/storage/storagedriver/)