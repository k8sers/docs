# 在OKE中安装Buildkit

BuildKit是一个工具包，用于以高效、可表达和可重复的方式转换源代码以构建工件。

Buildkit是一个编译工具，具有docker build/push 等功能，也能缓存中间步骤。

**但注意，编译的中间缓存产品无法上传到OCIR中。**也就是说 下面2个参数的type及目标不能是

`registry` 和OCIR的地址：`--import-cache type=local`  `--export-cache type=local`

![Untitled](Untitled%207.png)

---

## 安装 Buildkit

应用 [https://github.com/moby/buildkit/blob/master/examples/kubernetes/pod.privileged.yaml](https://github.com/moby/buildkit/blob/master/examples/kubernetes/pod.privileged.yaml)， 如果上不了github就用下面的文件

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: buildkitd
spec:
  containers:
    - name: buildkitd
      image: moby/buildkit:master
      readinessProbe:
        exec:
          command:
            - buildctl
            - debug
            - workers
        initialDelaySeconds: 5
        periodSeconds: 30
      livenessProbe:
        exec:
          command:
            - buildctl
            - debug
            - workers
        initialDelaySeconds: 5
        periodSeconds: 30
      securityContext:
        privileged: true
```

```bash
kubectl apply -f pod.privileged.yaml
```

## 配置认证

在跳板机或本地编写docker的登录认证文件。

```bash
nano ~/.docker/config.json
```

```json
{
  "auths": {
    "<私有仓库地址>": {
      "auth": "<认证信息，就是把 用户名:密码 用base64编码后的字符串>"
    }
  }
}
```

比如：

```json
{
        "auths": {
                "iad.ocir.io": {
                        "auth": "xxxxxxxxxx"
                }
        }
}
```

<aside>
💡 只需要文件，不需要安装docker等软件。当然你也可以安装**docker社区版**，然后用 docker login  来产生这个认证文件

</aside>

```bash
sudo yum-config-manager --add-repo  https://download.docker.com/linux/centos/docker-ce.repo
docker login -u <租户>/<用户> <区域>.ocir.io 
```

## 测试

从https://github.com/moby/buildkit/releases/ 上下载工具包，解压后得到builctl工具，并把buildctl添加到$PATH中

```bash
wget https://github.com/moby/buildkit/releases/download/v0.13.0/buildkit-v0.13.0.linux-amd64.tar.gz
tar xzvf buildkit-v0.13.0.linux-amd64.tar.gz
```

测试打包并推送

```bash
buildctl --addr kube-pod://buildkitd info

./buildctl \
  --addr kube-pod://buildkitd \
  build --frontend dockerfile.v0 --local context=./ --local dockerfile=./ \
  --output type=image,name=iad.ocir.io/sehubjapacprod/wilbur/abc:test.06,push=true
```

## 参考资料

- docker login 凭证 ： [https://blog.csdn.net/Rambo_Yang/article/details/108294632](https://blog.csdn.net/Rambo_Yang/article/details/108294632)
- buildkit: [https://github.com/moby/buildkit/tree/master](https://github.com/moby/buildkit/tree/master)
- 官方关于docker layer的说明
    - [https://docs.docker.com/build/guide/layers/](https://docs.docker.com/build/guide/layers/)
    - [https://docs.docker.com/storage/storagedriver/](https://docs.docker.com/storage/storagedriver/)