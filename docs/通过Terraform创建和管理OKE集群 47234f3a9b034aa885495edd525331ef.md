# é€šè¿‡Terraformåˆ›å»ºå’Œç®¡ç†OKEé›†ç¾¤

è¿™æ˜¯ä¸€ç§é«˜çº§çš„åˆ›å»ºOKEé›†ç¾¤æ–¹æ¡ˆï¼Œé€‚åˆæœ‰Terraformç»éªŒçš„äººï¼Œä»¥åŠæ˜ç¡®éœ€è¦TFæ§åˆ¶èµ„æºçš„åœºæ™¯ã€‚ 

ä¸€æ—¦ä½¿ç”¨äº†TFè¿›è¡Œèµ„æºåˆ›å»ºï¼Œåç»­çš„èµ„æºç®¡ç†å·¥ä½œå»ºè®®ä¹Ÿç”±TFå®Œæˆï¼Œé¿å…ä»OCI Consoleé¡µé¢ç›´æ¥å…³è”ï¼Œå¦åˆ™å®¹æ˜“å¼•èµ·ç®¡ç†æ··ä¹±ã€‚

å¦å¤–éœ€æ³¨æ„ï¼Œç”±OKEåˆ›å»ºå‡ºçš„LBã€å—å­˜å‚¨ç­‰èµ„æºæ— æ³•å½’æ¡£åˆ°TFç®¡ç†çš„èµ„æºä¸­ã€‚

ç›¸å…³æ–‡æ¡£ï¼š

- [OCIå®˜æ–¹TFæ–‡æ¡£ä¸­çš„ä¸¾ä¾‹](https://docs.oracle.com/en-us/iaas/developer-tutorials/tutorials/tf-cluster/01-summary.htm)
- [OKE Terraform Moduleå®˜æ–¹æ–‡æ¡£](https://oracle-terraform-modules.github.io/terraform-oci-oke/gs/intro.html#oracle-container-engine-for-kubernetes-oke-terraform-module)
- [Githubä¸Šçš„ç®€æ˜“Demo](https://github.com/terraform-providers/terraform-provider-oci/tree/master/examples/container_engine)
- [Githubä¸Šçš„OKE+DevOps Demo](https://github.com/oracle-quickstart/oci-arch-devops/tree/master/devops_oke)
- [TFå®˜ç½‘å½’æ¡£çš„ Oracle Cloud Infrastructure Provider æ–‡æ¡£](https://registry.terraform.io/providers/oracle/oci/latest/docs)

![Untitled](Untitled%2064.png)

---

## ç”¨æ³•

### å…‹éš†å­˜å‚¨åº“

å…‹éš† git å­˜å‚¨åº“å¹¶ç­¾å‡º 5.x åˆ†æ”¯ï¼š

```bash
git clone https://github.com/oracle-terraform-modules/terraform-oci-oke.git tfoke
cd tfoke
git checkout 5.x
```

### åˆ›é€ 

åˆå§‹åŒ–åŒ…å« Terraform é…ç½®æ–‡ä»¶çš„å·¥ä½œç›®å½•ï¼Œå¹¶å¯é€‰æ‹©å‡çº§æ¨¡å—ä¾èµ–é¡¹ï¼š

```bash
terraform init --upgrade
```

è¿è¡Œè®¡åˆ’å¹¶åº”ç”¨å‘½ä»¤æ¥åˆ›å»º OKE é›†ç¾¤å’Œå…¶ä»–ç»„ä»¶ï¼š

```bash
terraform plan
terraform apply
```

æ‚¨å¯ä»¥ä½¿ç”¨æ­¤ terraform è„šæœ¬ä½¿ç”¨ OKE ä¸­æä¾›çš„æœ€æ–°ç‰ˆæœ¬çš„ Kubernetes åˆ›å»º Kubernetes é›†ç¾¤ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ`kubernetes_version`terraform.tfvars.example ä¸­çš„å‚æ•°è®¾ç½®ä¸ºâ€œLATESTâ€ã€‚æœ‰å…³ OKE çš„å…¶ä»–å¯ç”¨å‚æ•°ï¼Œè¯·å‚é˜…[Terraform é€‰é¡¹ã€‚](https://oracle-terraform-modules.github.io/terraform-oci-oke/gs/inputs_submodule.html#cluster)

ä½¿ç”¨å‚æ•°*cluster_name*æ ¹æ®éœ€è¦æ›´æ”¹é›†ç¾¤çš„åç§°ã€‚

### è¿æ¥é›†ç¾¤

**æ³¨æ„ï¼š**Â TODO æ·»åŠ å†…å®¹

kubectl é»˜è®¤å®‰è£…åœ¨ Operator ä¸»æœºä¸Šï¼Œå¹¶ä¸” kubeconfig æ–‡ä»¶è®¾ç½®åœ¨é»˜è®¤ä½ç½®ï¼ˆ~/.kube/configï¼‰ï¼Œå› æ­¤æ‚¨æ— éœ€æ¯æ¬¡ç™»å½• Operator ä¸»æœºæ—¶éƒ½è®¾ç½® KUBECONFIG ç¯å¢ƒå˜é‡ã€‚

---

`instance principal`å¿…é¡»åœ¨ç›®æ ‡é›†ç¾¤ä¸Šæˆäºˆæ“ä½œå‘˜çš„æƒé™`MANAGE`æ‰èƒ½é…ç½®ç®¡ç†å‘˜ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚

- [å¯ç”¨å®ä¾‹è°ƒç”¨æœåŠ¡çš„æ­¥éª¤](https://docs.oracle.com/en-us/iaas/Content/Identity/Tasks/callingservicesfrominstances.htm#setup)
- [ä¸º Kubernetes å®¹å™¨å¼•æ“ç¼–å†™ç­–ç•¥](https://docs.oracle.com/en-us/iaas/Content/Identity/Reference/contengpolicyreference.htm)

---

å°†ä¸ºæ“ä½œå‘˜ä¸»æœºä¸Šçš„ kubectl åˆ›å»ºåˆ«åâ€œÂ *k â€ã€‚*

å¦‚æœæ‚¨æƒ³åœ¨æœ¬åœ°ä½¿ç”¨ kubectlï¼Œè¯·é¦–å…ˆåœ¨æœ¬åœ°[å®‰è£…å¹¶é…ç½® OCI CLI](https://docs.oracle.com/en-us/iaas/Content/API/Concepts/cliconcepts.htm#Command_Line_Interface_CLI)ã€‚ç„¶åï¼Œå®‰è£… kubectl å¹¶å°† KUBECONFIG è®¾ç½®ä¸ºé…ç½®æ–‡ä»¶è·¯å¾„ã€‚

```bash

export KUBECONFIG=path/to/kubeconfig

```

ä¸ºäº†èƒ½å¤Ÿè·å– kubeconfig æ–‡ä»¶ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ terraform è·å–å‡­è¯å¹¶ä»¥é¦–é€‰å­˜å‚¨æ ¼å¼å­˜å‚¨ï¼ˆä¾‹å¦‚ï¼šæ–‡ä»¶ã€ä¿ç®¡åº“ã€å­˜å‚¨æ¡¶...ï¼‰ï¼š

```

# OKE cluster creation.
module "oke_my_cluster" {
#...
}
# Obtain cluster Kubeconfig.
data "oci_containerengine_cluster_kube_config" "kube_config" {
  cluster_id = module.oke_my_cluster.cluster_id
}
# Store kubeconfig in vault.
resource "vault_generic_secret" "kube_config" {
  path = "my/cluster/path/kubeconfig"
  data_json = jsonencode({
    "data" : data.oci_containerengine_cluster_kube_config.kube_config.content
  })
}
# Store kubeconfig in file.
resource "local_file" "kube_config" {
  content         = data.oci_containerengine_cluster_kube_config.kube_config.content
  filename        = "/tmp/kubeconfig"
  file_permission = "0600"
}
```

<aside>
ğŸ’¡ æç¤ºï¼šç¡®ä¿å®‰è£…ä¸ OKE Kubernetes ç‰ˆæœ¬ç›¸åŒçš„ kubectl ç‰ˆæœ¬ä»¥å®ç°å…¼å®¹æ€§ã€‚

</aside>

### é”€æ¯

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥é”€æ¯ Terraform åˆ›å»ºçš„åŸºç¡€è®¾æ–½ï¼š

```bash
terraform destroy
```

æ‚¨è¿˜å¯ä»¥è¿›è¡Œæœ‰é’ˆå¯¹æ€§çš„é”€æ¯ï¼Œä¾‹å¦‚

```bash
terraform destroy --target=module.workers
```