# 通过Terraform创建和管理OKE集群

这是一种高级的创建OKE集群方案，适合有Terraform经验的人，以及明确需要TF控制资源的场景。 

一旦使用了TF进行资源创建，后续的资源管理工作建议也由TF完成，避免从OCI Console页面直接关联，否则容易引起管理混乱。

另外需注意，由OKE创建出的LB、块存储等资源无法归档到TF管理的资源中。

相关文档：

- [OCI官方TF文档中的举例](https://docs.oracle.com/en-us/iaas/developer-tutorials/tutorials/tf-cluster/01-summary.htm)
- [OKE Terraform Module官方文档](https://oracle-terraform-modules.github.io/terraform-oci-oke/gs/intro.html#oracle-container-engine-for-kubernetes-oke-terraform-module)
- [Github上的简易Demo](https://github.com/terraform-providers/terraform-provider-oci/tree/master/examples/container_engine)
- [Github上的OKE+DevOps Demo](https://github.com/oracle-quickstart/oci-arch-devops/tree/master/devops_oke)
- [TF官网归档的 Oracle Cloud Infrastructure Provider 文档](https://registry.terraform.io/providers/oracle/oci/latest/docs)

![Untitled](Untitled%2064.png)

---

## 用法

### 克隆存储库

克隆 git 存储库并签出 5.x 分支：

```bash
git clone https://github.com/oracle-terraform-modules/terraform-oci-oke.git tfoke
cd tfoke
git checkout 5.x
```

### 创造

初始化包含 Terraform 配置文件的工作目录，并可选择升级模块依赖项：

```bash
terraform init --upgrade
```

运行计划并应用命令来创建 OKE 集群和其他组件：

```bash
terraform plan
terraform apply
```

您可以使用此 terraform 脚本使用 OKE 中提供的最新版本的 Kubernetes 创建 Kubernetes 集群。默认情况下，`kubernetes_version`terraform.tfvars.example 中的参数设置为“LATEST”。有关 OKE 的其他可用参数，请参阅[Terraform 选项。](https://oracle-terraform-modules.github.io/terraform-oci-oke/gs/inputs_submodule.html#cluster)

使用参数*cluster_name*根据需要更改集群的名称。

### 连接集群

**注意：** TODO 添加内容

kubectl 默认安装在 Operator 主机上，并且 kubeconfig 文件设置在默认位置（~/.kube/config），因此您无需每次登录 Operator 主机时都设置 KUBECONFIG 环境变量。

---

`instance principal`必须在目标集群上授予操作员的权限`MANAGE`才能配置管理员用户上下文。

- [启用实例调用服务的步骤](https://docs.oracle.com/en-us/iaas/Content/Identity/Tasks/callingservicesfrominstances.htm#setup)
- [为 Kubernetes 容器引擎编写策略](https://docs.oracle.com/en-us/iaas/Content/Identity/Reference/contengpolicyreference.htm)

---

将为操作员主机上的 kubectl 创建别名“ *k ”。*

如果您想在本地使用 kubectl，请首先在本地[安装并配置 OCI CLI](https://docs.oracle.com/en-us/iaas/Content/API/Concepts/cliconcepts.htm#Command_Line_Interface_CLI)。然后，安装 kubectl 并将 KUBECONFIG 设置为配置文件路径。

```bash

export KUBECONFIG=path/to/kubeconfig

```

为了能够获取 kubeconfig 文件，您需要使用 terraform 获取凭证并以首选存储格式存储（例如：文件、保管库、存储桶...）：

```

# OKE cluster creation.
module "oke_my_cluster" {
#...
}
# Obtain cluster Kubeconfig.
data "oci_containerengine_cluster_kube_config" "kube_config" {
  cluster_id = module.oke_my_cluster.cluster_id
}
# Store kubeconfig in vault.
resource "vault_generic_secret" "kube_config" {
  path = "my/cluster/path/kubeconfig"
  data_json = jsonencode({
    "data" : data.oci_containerengine_cluster_kube_config.kube_config.content
  })
}
# Store kubeconfig in file.
resource "local_file" "kube_config" {
  content         = data.oci_containerengine_cluster_kube_config.kube_config.content
  filename        = "/tmp/kubeconfig"
  file_permission = "0600"
}
```

<aside>
💡 提示：确保安装与 OKE Kubernetes 版本相同的 kubectl 版本以实现兼容性。

</aside>

### 销毁

运行以下命令来销毁 Terraform 创建的基础设施：

```bash
terraform destroy
```

您还可以进行有针对性的销毁，例如

```bash
terraform destroy --target=module.workers
```