# 定制创建OKE集群

[在“自定义创建”工作流程中使用自定义设置。](https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengcreatingclusterusingoke_topic-Using_the_Console_to_create_a_Custom_Cluster_with_Explicitly_Defined_Settings.htm#create-custom-cluster)这种方法使您可以最大程度地控制新集群。您可以显式定义新集群的属性，包括加密设置。您还可以显式指定要使用哪些现有网络资源，包括用于创建 Kubernetes API 端点、工作节点和负载均衡器的现有公共或私有子网。

<aside>
💡 请注意，虽然您通常会在“自定义创建”工作流程中定义新集群时立即定义节点池，但您不必这样做。您可以创建一个没有节点池的集群，然后再添加节点池。创建最初没有节点池的集群的原因之一是，如果您打算安装和配置 Calico 等网络策略提供程序来支持 Kubernetes NetworkPolicy 资源。如果您在现有节点池（其中 pod 已在运行）的集群上安装 Calico，则在 Calico 安装完成后，您必须重新创建 pod。例如，通过运行`kubectl rollout restart`命令。如果您在集群中创建任何节点池之前在集群上安装 Calico（推荐），则可以确保不会重新创建 Pod。请参阅[示例：安装 Calico 和设置网络策略](https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengsettingupcalico.htm#Example_Installing_Calico_and_Setting_Up_Network_Policies)。

</aside>

定制创建与快速创建的主要区别在于“定制创建”不会自动创建网络，而是使用现有的VCN。所以在使用定制创建前，请准备好它，可以参考本站的文章：

- OKE基本网络配置
- OKE网络最佳实践

如果你没有明确的网络需求，或者网络需求可以在后续慢慢调整，可以参考本站的文章：

- 快速创建OKE集群

当遇到网络问题时，可以参考甲骨文员工常用的方案：先用自动创建OKE集群创建好VCN（然后删除OKE保留VCN），再定制OKE集群。

![Untitled](Untitled%2052.png)

---

## **1. 授权**

以下为授权示例，你可以根据情况进行修改：

```
ALLOW any-user to use virtual-network-family in tenancy where request.principal.type = 'cluster'
Allow any-user to use private-ips in tenancy where request.principal.type = 'cluster'
ALLOW any-user to manage file-family in tenancy where request.principal.type = 'cluster'
```

<aside>
💡 如果网络在VCN与OKE不在同一区间，因OKE服务无权关联其他区间的资源，需要额外授权OKE拥有“分配私网IP”的权限，否则Worknode创建失败（部分Pod因无IP而启动失败）。

</aside>

## **2. 创建OKE集群**

![Untitled](Untitled%2046.png)

![Untitled](Untitled%2052.png)

注意K8s版本:

![Untitled](Untitled%2053.png)

如果需要，可以打开高级选项，选择一些你需要的附加组件：

![Untitled](Untitled%2054.png)

OKE支持2种Pod网络：VCN-Native和Flannel， 具体情况见本站的网络部分文章。无特殊需求，选默认的VCN-Native网络即可。

另外为OKE的LB service自定子网（也就是 LB的 IaaS云服务放到哪个子网中。普通的K8s svc用的是下图最下方的10.96.0.0/16这个可更改的网段），这个LB占用的子网将无法被Node或Pod使用（因为OKE要维护这个子网里面的网络策略 Security List，如果跟Node/Pod共用，将带来安全风险）。

如果是在K8s API 端点在公共子网中，一定要勾选“为API端点分配公共IP地址”。

![Untitled](Untitled%2055.png)

节点类型决定了整个集群的类型（当前集群无法混合使用2种节点类型），区别见本站关于虚拟节点的文章。无特殊情况，选默认的托管类型。

Worker Node的版本最好是跟集群版本保持一致。

另外为节点指定一个子网。

![Untitled](Untitled%2056.png)

<aside>
💡 跟“快速创建OKE集群”不同，这里可以让worker node位于公共子网中（因为Pod可以在下面的步骤中指定到另一个私有子网中）, 互联网可以直接通过work node的免费公网IP访问这些nodes。 但生产环境没必要这么做。

</aside>

节点类型一般选AMD的Standard.E4.Flex或Intel的Standard3.Flex,  带有Flex的型号都支持灵活调整CPU及内存大小。镜像一般选默认的即可：

![Untitled](Untitled%2057.png)

这里我将指导大家把启动盘配置成100GB（你们按需执行），本文章后续还有一个初始化脚本的步骤配合执行：

![Untitled](Untitled%2058.png)

为Pod分配一个私有子网。另外这里还有一个高级选项：“一台Node最大的Pod数”。 1 OCPU只能选31个（32-1），2 OCPU能达到63个（64-1)。

![Untitled](Untitled%2059.png)

<aside>
💡  在OKE创建Worker Node的时候，那台Node的第二张网卡已经分配好了所有私网IP，以便创建Pod的时候能快速领取一个。 但OKE不会为Pod分配公网IP（因Pod数量庞大，事先分配需要浪费大量公网IP），这也是Pod在公共子网中无法主动访问互联网的原因。

</aside>

点开节点池的高级选项，这里有很多地方需要注意：

- 驱逐宽限期： node被删除前，OKE会等待上面的工作负载迁移到新的集群才真正删除。 指导这个默认1小时的宽限期结束，OKE将强制删除Node。
- 初始化脚本： node第一次启动的时候执行的脚本。脚本的第一条命令是Work Node所需的初始化脚本，请别删掉它。 在其后面，我们可以添加各种功能的脚步，比如下面的自动扩容系统盘，加了最后那3行命令后，所有自动创建的node将在Linux层面自动识别扩容后的系统盘（前提是前面步骤分配了更大的系统盘）。

![Untitled](Untitled%2060.png)

```bash
#!/bin/bash
curl --fail -H "Authorization: Bearer Oracle" -L0 http://169.254.169.254/opc/v2/instance/metadata/oke_init_script | base64 --decode >/var/run/oke-init.sh
bash /var/run/oke-init.sh

sudo dd iflag=direct if=/dev/sda of=/dev/null count=1
echo "1" | sudo tee /sys/class/block/sda/device/rescan
echo "y" | sudo /usr/libexec/oci-growfs
```

你可以为节点打上K8s Labels，比如类似GPU-node的标签更便于调度AI工作负载：

![Untitled](Untitled%2061.png)

别忘记上传ssh公钥或下载自动生成的ssh秘钥，难讲某天需要登录node的Linux：

![Untitled](Untitled%2062.png)

在最后的复查页下方，有个是否创建基本集群的选项，选上后能省一点点费用，但无法管理附加组件（还记得吗，创建OKE的第一步我们已经管理过一次附加组件了）以及节点轮换功能，后续需要的时候可以再升级为增强型集群。基本集群适合开发、测试环境使用：

![Untitled](Untitled%2063.png)

点击创建，等待完成，完成后可以看到Kubernetes API Server 的端点地址：

![Untitled](Untitled%2051.png)