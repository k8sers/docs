# AWS LB流量无缝迁移到OCI LB方案

## 1. 准备工作

本地电脑上的软件：

- Postman

AWS

- 4层LB
- 7层LB
- EC2： 1 OCPU 2GB， 安装转发用的Nginx和模拟服务端的Nginx +
websocket测试服务端

OCI

- FLB
- Instance（VM）： 1 OCPU 2GB，CentOS 7, 安装Nginx +
websocket测试服务端

## 2. 流程示意

原环境

![tech-doc-master%25E4%25BA%2591%25E5%258E%2582%25E5%2595%2586%25E7%2594%25B2%25E9%25AA%25A8%25E6%2596%2587IaaSNetworkLBAWS_LB%25E6%2597%25A0%25E7%25BC%259D%25E8%25BF%2581%25E7%25A7%25BBOCI_LB%25E6%2596%25B9%25E6%25A1%2588.assetsimage-20230430153151646.png](tech-doc-master%25E4%25BA%2591%25E5%258E%2582%25E5%2595%2586%25E7%2594%25B2%25E9%25AA%25A8%25E6%2596%2587IaaSNetworkLBAWS_LB%25E6%2597%25A0%25E7%25BC%259D%25E8%25BF%2581%25E7%25A7%25BBOCI_LB%25E6%2596%25B9%25E6%25A1%2588.assetsimage-20230430153151646.png)

### Step 1.  AWS 前置 Nginx

在AWS LB前添加一个Nginx集群用于承载流量（本文有个前提，是EKS中的很多业务于AWSLB有非常多的配置，绑定太深，不能修改原有的AWS LB）

![tech-doc-master%25E4%25BA%2591%25E5%258E%2582%25E5%2595%2586%25E7%2594%25B2%25E9%25AA%25A8%25E6%2596%2587IaaSNetworkLBAWS_LB%25E6%2597%25A0%25E7%25BC%259D%25E8%25BF%2581%25E7%25A7%25BBOCI_LB%25E6%2596%25B9%25E6%25A1%2588.assetsimage-20230430153320915.png](tech-doc-master%25E4%25BA%2591%25E5%258E%2582%25E5%2595%2586%25E7%2594%25B2%25E9%25AA%25A8%25E6%2596%2587IaaSNetworkLBAWS_LB%25E6%2597%25A0%25E7%25BC%259D%25E8%25BF%2581%25E7%25A7%25BBOCI_LB%25E6%2596%25B9%25E6%25A1%2588.assetsimage-20230430153320915.png)

### Step 2. Nginx流量指向OCI LB

![Untitled](Untitled%2084.png)

### Step 3. CDN流量指向OCI LB

由于DNS刷新需要一定的时间，所以此时仍会有极少数从CDN的流量通过AWS LB+Nginx 转发至OCI LB

![Untitled](Untitled%2085.png)

等CDN的DNS都更新后，流量只会发给OCI LB

![Untitled](Untitled%2086.png)

## 3. Nginx配置说明

解除限制

```bash
sudo setenforce 0
sudo sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux
sudo sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
sudo systemctl disable firewalld
sudo systemctl stop firewalld
```

安装工具

```bash
#sudo rpm -Uvh  http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm
#Nginx
sudo yum install -y nginx

sudo systemctl enable nginx
sudo mkdir /etc/nginx/cert/
#上传证书到/etc/nginx/cert/这个目录中

```

在AWS上配置转发Nginx

```bash
sudo vi /etc/nginx/conf.d/gema.conf
```

```bash
server {
    listen       80;
    server_name  .oracle.fit;
    access_log  /var/log/nginx/http.access.log main;

    location /http {
        proxy_pass http://oci_http;
        proxy_headers_hash_max_size 1024;
        proxy_headers_hash_bucket_size 128;
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_http_version 1.1;
    }
    location / {
        root   html;
        index  index.html index.htm;
    }
}

server {
    listen       443 ssl;
    #listen 443 ssl http2 default_server;
    #listen [::]:443 ssl http2 default_server;
    server_name  https1.oracle.fit;

    access_log  /var/log/nginx/https1.access.log main;
    ssl_certificate cert/https1.oracle.fit.crt;
    ssl_certificate_key cert/https1.oracle.fit.key;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location  / {
        proxy_pass https://oci_https;
        proxy_headers_hash_max_size 1024;
        proxy_headers_hash_bucket_size 128;
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_http_version 1.1;
        #rewrite ^/app/(.*)$ /$1 break;
    }
}

server {
    listen       443 ssl;
    #listen 443 ssl http2 default_server;
    #listen [::]:443 ssl http2 default_server;
    server_name  https2.oracle.fit;

    access_log  /var/log/nginx/https2.access.log main;
    ssl_certificate cert/https2.oracle.fit.crt;
    ssl_certificate_key cert/https2.oracle.fit.key;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location  / {
        proxy_pass https://oci_https;
        proxy_headers_hash_max_size 1024;
        proxy_headers_hash_bucket_size 128;
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_http_version 1.1;
        #rewrite ^/app/(.*)$ /$1 break;
    }
}

server {
    listen       443 ssl;
    #listen 443 ssl http2 default_server;
    #listen [::]:443 ssl http2 default_server;
    server_name  wss1.oracle.fit;

    access_log  /var/log/nginx/wss1.access.log main;
    ssl_certificate cert/wss1.oracle.fit.crt;
    ssl_certificate_key cert/wss1.oracle.fit.key;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location  / {
        proxy_pass https://oci_https;
        proxy_headers_hash_max_size 1024;
        proxy_headers_hash_bucket_size 128;
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        #rewrite ^/app/(.*)$ /$1 break;
    }
}

server {
    listen       443 ssl;
    #listen 443 ssl http2 default_server;
    #listen [::]:443 ssl http2 default_server;
    server_name  wss2.oracle.fit;

    access_log  /var/log/nginx/wss2.access.log main;
    ssl_certificate cert/wss2.oracle.fit.crt;
    ssl_certificate_key cert/wss2.oracle.fit.key;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location  / {
        proxy_pass https://oci_https;
        proxy_headers_hash_max_size 1024;
        proxy_headers_hash_bucket_size 128;
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        #rewrite ^/app/(.*)$ /$1 break;
    }
}
```

在http { } 中 删除原来的80 端口服务内容，并加入以下内容

```bash
sudo vi /etc/nginx/nginx.conf
```

```

http {

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" "myHeader:$http_myHeader"';

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    upstream oci_https {
        server https-oci.oracle.fit:443 max_fails=3 fail_timeout=15;
    }
    upstream oci_http {
        server http-oci.oracle.fit:80 max_fails=3 fail_timeout=15;
    }

    # ...
}
```

在OCI上配置测试Nginx

```bash
sudo vi /etc/nginx/conf.d/site1.conf
```

```
server {
    listen       80;
    server_name  http-oci.oracle.fit;
    access_log  /var/log/nginx/http-oci.access.log main;
    location /http {
        proxy_pass http://app_http;
        proxy_headers_hash_max_size 1024;
        proxy_headers_hash_bucket_size 128;
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_http_version 1.1;
    }
    location / {
        root   html;
        index  index.html index.htm;
    }
}

server {
    listen       443 ssl;
    #listen 443 ssl http2 default_server;
    #listen [::]:443 ssl http2 default_server;
    server_name  https-oci.oracle.fit;

    access_log  /var/log/nginx/https-oci.access.log main;
    ssl_certificate cert/server.crt;
    ssl_certificate_key cert/server.key;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location /http {
        proxy_pass http://app_http;
        proxy_headers_hash_max_size 1024;
        proxy_headers_hash_bucket_size 128;
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_http_version 1.1;
    }

    location  /websocket {
        proxy_pass https://app_https;
        proxy_headers_hash_max_size 1024;
        proxy_headers_hash_bucket_size 128;
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        #rewrite ^/app/(.*)$ /$1 break;
    }

    location = /50x.html {
        root   html;
    }

    location / {
        root   html;
        index  index.html index.htm;
    }

}
```

在http { } 中加入以下内容

```bash
sudo vi /etc/nginx/nginx.conf
```

```

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" "myHeader:$http_myHeader"';
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    upstream app_https {
        server localhost:8443 max_fails=3 fail_timeout=15;
    }

    upstream app_http {
        server localhost:8080 max_fails=3 fail_timeout=15;
    }

    # ...
}
```

```bash
sudo systemctl restart nginx
```